<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Community Stats - Footprint Logger</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üåç Community Emissions</h1>
      <nav>
        <a href="index.html">üè† Home</a>
        <a href="community.html">üåç Community</a>
      </nav>
    </header>

    <section
      id="login-prompt"
      style="display:none; text-align:center; margin-top:50px;"
    >
      <button
        onclick="window.location.href='index.html'"
        style="padding:15px 30px; font-size:18px; cursor:pointer;"
      >
        Login / Register
      </button>
    </section>

    <section id="community-stats" style="display:none;">
      <h2>Community Average</h2>
      <div id="community-average">Loading...</div>
    </section>

    <hr />

    <section id="leaderboard-section" style="display:none;">
      <h2>Low-Footprint Leaderboard</h2>
      <ol id="leaderboard"></ol>
      <button id="see-more-btn" style="display:none;">See More</button>
    </section>

    <hr />

    <section id="dominant-category-section" style="display:none;">
      <h2>Community Category Emissions (Highest ‚Üí Lowest)</h2>
      <ul id="category-ranking"></ul>
    </section>

    <script>
        const API_BASE = "/api";
        let token = localStorage.getItem("token") || null;
        let leaderboardPage = 0;
        const pageSize = 10;

        async function apiFetch(url) {
          const headers = {};
          if (token) headers["Authorization"] = `Bearer ${token}`;
          const res = await fetch(API_BASE + url, { headers });
          if (!res.ok) throw new Error("API error");
          return res.json();
        }

        async function loadCommunityAverage() {
          try {
            const avg = await apiFetch("/activities/community-average");
            document.getElementById("community-average").innerHTML = `
              <p>Total Users: ${avg.usersCount}</p>
              <p>Average per user: <strong>${avg.avgPerUser} kg CO‚ÇÇ</strong></p>
            `;
          } catch {
            document.getElementById("community-average").textContent = "Failed to load";
          }
        }

        async function loadLeaderboard() {
          try {
            const allLeaders = await apiFetch("/activities/leaderboard?days=7");
            const start = leaderboardPage * pageSize;
            const end = start + pageSize;
            const leaders = allLeaders.slice(start, end);

            const list = document.getElementById("leaderboard");
            list.innerHTML = "";

            const loggedInName = localStorage.getItem("name");
            const loggedInEmail = localStorage.getItem("email");

            leaders.forEach((u, i) => {
              const li = document.createElement("li");
              li.textContent = `${u.name || u.email} ‚Üí ${u.avgDaily} kg/day`;

              if (u.name === loggedInName || u.email === loggedInEmail) {
                li.style.color = "blue";
                li.style.fontWeight = "bold";
              }
              list.appendChild(li);
            });

            if (end < allLeaders.length) {
              document.getElementById("see-more-btn").style.display = "block";
            } else {
              document.getElementById("see-more-btn").style.display = "none";
            }
          } catch (err) {
            console.error(err);
          }
        }

        async function loadCommunityCategoryRanking() {
          try {
            const res = await apiFetch("/activities/all-community");
            const allUsersActivities = res.activities;

            // Flatten all nested activities into a single array
            const flatActivities = allUsersActivities.flatMap(entry => entry.activities);

            if (!flatActivities || flatActivities.length === 0) {
              document.getElementById("dominant-category-section").style.display = "none";
              return;
            }

            // Sum CO2 per category
            const totals = {};
            flatActivities.forEach(a => {
              // If totalCO2 is not stored, calculate from quantity * co2Value
              const co2 = a.totalCO2 || (a.quantity * a.co2Value);
              totals[a.category] = (totals[a.category] || 0) + co2;
            });

            // Sort categories from highest to lowest
            const sortedCategories = Object.entries(totals)
              .sort(([, a], [, b]) => b - a);

            const container = document.getElementById("dominant-category-section");
            // container.innerHTML = "<h3>Category Emissions Ranking</h3>";
            const ul = document.createElement("ul");

            sortedCategories.forEach(([cat, value]) => {
              const li = document.createElement("li");
              li.textContent = `${cat}: ${value.toFixed(2)} kg CO‚ÇÇ`;
              ul.appendChild(li);
            });

            container.appendChild(ul);
            container.style.display = "block";

          } catch (err) {
            console.error(err);
          }
        }


        document.getElementById("see-more-btn").addEventListener("click", () => {
          leaderboardPage++;
          loadLeaderboard();
        });
        window.addEventListener("DOMContentLoaded", () => {
        if (token) {
          // logged in
          document.getElementById("community-stats").style.display = "block";
          document.getElementById("leaderboard-section").style.display = "block";
          document.getElementById("dominant-category-section").style.display =
            "block";
          // loadDominantCategory();
          loadCommunityCategoryRanking();
          loadCommunityAverage();
          loadLeaderboard();
        } else {
          // logged out
          document.getElementById("login-prompt").style.display = "block";
        }
      });
    </script>
  </body>
</html>

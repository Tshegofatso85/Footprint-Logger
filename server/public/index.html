<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Footprint Logger</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>üåç Footprint Logger</h1>
      <nav>
        <a href="index.html">üè† Home</a>
        <a href="community.html">üåç Community</a>
      </nav>
    </header>

    <!-- ===================== -->
    <!-- Authentication -->
    <!-- ===================== -->
    <section id="auth-section">
      <h2>Account</h2>
      <div id="auth-forms">
        <!-- Register -->
        <form id="register-form">
          <h3>Register</h3>
          <input type="text" id="reg-name" placeholder="Name" required />
          <input type="email" id="reg-email" placeholder="Email" required />
          <input
            type="password"
            id="reg-password"
            placeholder="Password"
            required
          />
          <button type="submit">Register</button>
        </form>

        <!-- Login -->
        <form id="login-form">
          <h3>Login</h3>
          <input type="email" id="login-email" placeholder="Email" required />
          <input
            type="password"
            id="login-password"
            placeholder="Password"
            required
          />
          <button type="submit">Login</button>
        </form>

        <button id="logout-btn" style="display:none;">Logout</button>
      </div>
      <p id="welcome-msg"></p>
    </section>

    <hr />

    <!-- ===================== -->
    <!-- Activity logger -->
    <!-- ===================== -->
    <section id="logger-section" style="display:none;">
      <h2>Log an Activity</h2>
      <form id="activity-form">
        <input type="date" id="date" />

        <!-- Dropdown for predefined activities -->
        <select id="activity-select" required>
          <option value="">-- Select Activity --</option>
        </select>

        <!-- Auto-filled fields -->
        <input type="text" id="category" placeholder="Category" readonly />
        <input type="text" id="unit" placeholder="Unit" readonly />
        <input
          type="number"
          id="quantity"
          step="0.01"
          placeholder="Quantity"
          required
        />
        <input
          type="number"
          id="co2-value"
          step="0.01"
          placeholder="CO‚ÇÇ per unit (kg)"
          readonly
        />

        <button type="submit">Log Activity</button>
      </form>
    </section>

    <hr />

    <!-- ===================== -->
    <!-- Dashboard -->
    <!-- ===================== -->
    <section id="dashboard" style="display:none;">
      <h2>Your Dashboard</h2>
      <div id="loader" style="display:none;">Loading...</div>
      <div id="log-container"></div>
      <div id="summary"></div>
      <div id="leaderboard"></div>
    </section>

    <section id="activity-table" style="display:none;">
      <h2>All Activities</h2>
      <label for="filter-category">Filter by category:</label>
      <select id="filter-category">
        <option value="">All</option>
        <option value="transport">Transport</option>
        <option value="food">Food</option>
        <option value="energy">Energy</option>
        <option value="waste">Waste</option>
      </select>
      <table border="1">
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Total CO‚ÇÇ</th>
          </tr>
        </thead>
        <tbody id="activity-table-body"></tbody>
      </table>
      <p id="activity-total"></p>
    </section>

    <script src="script.js"></script>
    <script>
      const regForm = document.getElementById("register-form");
      const loginForm = document.getElementById("login-form");
      const logoutBtn = document.getElementById("logout-btn");
      const welcomeMsg = document.getElementById("welcome-msg");
      const loggerSection = document.getElementById("logger-section");
      const dashboard = document.getElementById("dashboard");
      const activityTable = document.getElementById("activity-table");

      function showLoader() {
        document.getElementById("loader").style.display = "block";
      }
      function hideLoader() {
        document.getElementById("loader").style.display = "none";
      }

      async function updateUI(user) {
        if (user) {
          welcomeMsg.textContent = `Welcome, ${user.name || user.email}`;
          regForm.style.display = "none";
          loginForm.style.display = "none";
          logoutBtn.style.display = "inline-block";
          loggerSection.style.display = "block";
          dashboard.style.display = "block";
          activityTable.style.display = "block";
        } else {
          welcomeMsg.textContent = "";
          regForm.style.display = "block";
          loginForm.style.display = "block";
          logoutBtn.style.display = "none";
          loggerSection.style.display = "none";
          dashboard.style.display = "none";
          activityTable.style.display = "none";
          // Clear dashboard data when logged out
          document.getElementById("log-container").innerHTML = "";
          document.getElementById("summary").innerHTML = "";
          document.getElementById("leaderboard").innerHTML = "";
        }
      }

      regForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("reg-name").value;
        const email = document.getElementById("reg-email").value;
        const password = document.getElementById("reg-password").value;
        try {
          const user = await registerUser(email, password, name);
          updateUI(user);
          showLoader();
          await renderLogs();
          await renderActivityTable();
          // await renderSummary();
          // await renderLeaderboard();
          hideLoader();
        } catch (err) {
          // alert("Registration failed");
          hideLoader();
        }
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        try {
          const user = await loginUser(email, password);
          updateUI(user);
          showLoader();
          await renderLogs();
          await renderActivityTable();
          // await renderSummary();
          // await renderLeaderboard();
          hideLoader();
        } catch (err) {
          alert("Login failed" + err);
          hideLoader();
        }
      });

      logoutBtn.addEventListener("click", () => {
        logoutUser();
        updateUI(null);
      });

      if (localStorage.getItem("token")) {
        showLoader();
        getWeeklySummary()
          .then(() => {
            updateUI({
              name: localStorage.getItem("name"),
              email: localStorage.getItem("email"),
            });
            return Promise.all([renderLogs()]);
          })
          .catch(() => updateUI(null))
          .finally(() => hideLoader());
      } else {
        updateUI(null);
      }
    </script>
  </body>
</html>
